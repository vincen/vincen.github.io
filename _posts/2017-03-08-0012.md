---
layout: post
title: 用一天学完了ZooKeeper
categories: server-side
tags: zookeeper java
---
# ZooKeeper 概念
### 集群角色

Leader，Follower，Observer

Leader服务器是整个Zookeeper集群工作机制中的核心  
Follower服务器是Zookeeper集群状态的跟随者  
Observer服务器充当一个观察者的角色  

### 会话
客户端与服务端是通过建立TCP长连接来维持Session。通过这个连接能够进行心跳检测来保持会话的有效性。

### 数据节点
数据单元Znode分为：临时节点，永久节点  
ZooKeeper的数据模型是树型数据结构。  
在服务器出现故障时，其在ZooKeeper中注册的临时节点，会自动删除掉。

### 版本

| 版本类型     | 说明             |
| -------- | -------------- |
| version  | 当前数据节点数据内容的版本号 |
| cversion | 当前数据节点子节点的版本号  |
| aversion | 当前数据节点ACL变更版本号 |

### watcher

事件监听器能把数据节点发的变化，通知给感兴趣的客户端。

### ACL

五种权限类型：  
CREATE, READ, WRITE, DELETE, ADMIN(设置节点ACL的权限)



# ZooKeeper 技术问题汇总

### 启动时报NoSuchMethodError

{% highlight java%}

java.lang.NoSuchMethodError: org.apache.zookeeper.server.quorum.flexible.QuorumMaj.<init>(Ljava/util/Map;)V

    at org.apache.curator.framework.imps.EnsembleTracker.<init>(EnsembleTracker.java:59)
    at org.apache.curator.framework.imps.CuratorFrameworkImpl.<init>(CuratorFrameworkImpl.java:158)
    at org.apache.curator.framework.CuratorFrameworkFactory$Builder.build(CuratorFrameworkFactory.java:156)
    at com.fuqssi.lancelot.zookeeper.CuratorClient.<clinit>(CuratorClient.java:19)
{% endhighlight %}

上述异常是因为在Maven中引用Curator.jar之前，引入了ZooKeeper.jar。导致Curator编译时引用的ZooKeeper和自己引用的ZooKeeper版本不一致。  
删掉自己引用的ZooKeeper，引入Curator之后，Maven会解决ZooKeeper的依赖。

